<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Gorretora</title>
</head>

<body>
  <h2>Seja muito bem-vindo a GOrretora</h2>

  <script>
    var time_id = Date.now()
    var array_lat_vrau = []

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function writeFile() {
      let a = document.createElement('a');
      txt = 'id;latencia;tick\n'
      array_lat_vrau.forEach(function (evt) {
        txt = txt + evt.id + ';' + evt.lat + + ';' + evt.tick + '\n'
      })
      a.href = "data:application/octet-stream," + encodeURIComponent(txt);
      let myuuid = uuidv4();

      a.download = myuuid + '.txt';
      a.click();
    }
    let socket = new WebSocket("ws://127.0.0.1:8080/ws?ticks=GOGL34&ticks=AAPL34&ticks=HAPV3&ticks=HBOR3&ticks=HBTS5&ticks=HETA4&ticks=HGTX3&ticks=HOME34&ticks=HPQB34&ticks=HYPE3&ticks=IBMB34&ticks=IDNT3&ticks=IDVL3&ticks=IDVL4&ticks=IGTA3&ticks=IRBR3&ticks=ITLC34&ticks=ITSA3&ticks=ITSA4&ticks=ITUB3&ticks=ITUB4&ticks=JBDU3&ticks=JBDU4&ticks=JBSS3&ticks=JFEN3&ticks=JHSF3&ticks=JNJB34&ticks=JPSA3&ticks=JSLG3&ticks=KEPL3&ticks=KHCB34&ticks=KLBN3&ticks=KLBN4&ticks=KLBN11&ticks=KROT3&ticks=LAME3&ticks=LAME4&ticks=LCAM3&ticks=LEVE3&ticks=LIGT3&ticks=LILY34&ticks=LINX3&ticks=LIQO3&ticks=LLIS3&ticks=LMTB34&ticks=LOGG3&ticks=LOGN3&ticks=LPSB3&ticks=LREN3&ticks=MACY34");
    console.log("Attempting Connection...");
    console.log(socket)

    socket.onopen = () => {
      console.log("Successfully Connected");
      socket.send("Hi From the Client!")
      time_id = Date.now()
    };

    socket.onmessage = (msg) => {
      re = RegExp('- ([0-9]+) -')
      re_2 = RegExp('^([A-Z0-9]+) -')
      ts = Date.now()
      _id = Math.round((ts - time_id) / 5000)
      timestamp = Number(((msg.data).toString()).match(re)[1])
      array_lat_vrau.push({ "id": _id, "lat": (Date.now() - 10800000) - timestamp, "tick": ((msg.data).toString()).match(re_2)[1] })
      console.log(msg.data)
    }

    socket.onclose = event => {
      console.log("Socket Closed Connection: ", event);
      socket.send("Client Closed!")
      writeFile()

    };

    socket.onerror = error => {
      console.log("Socket Error: ", error);
    };
  </script>
</body>

</html>